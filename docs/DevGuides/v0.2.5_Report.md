# MatterStack v0.2.5 Implementation Report – Task Attempts, Provenance-Safe Reruns, and HPC Validation Harness

**Date:** 2025-12-14
**Status:** Release gate green (core feature complete; full suite passing with mitigation flag in this environment)
**Focus:** Provenance-safe reruns via **Task Attempts**, attempt-scoped evidence, attempt-aware orchestration/HPC, and a canonical validation workspace.

---

## 1. Executive Summary

MatterStack v0.2.5 introduces a first-class “Task Attempts” model to support **robust iteration** on long-running campaigns without losing provenance. The implementation delivers:

1. **Schema v2**: Attempts as a 1:N execution history per logical task, with automatic v1→v2 migration.  
2. **Attempt-aware orchestration loop**: polling, concurrency, submission, and results collection operate on attempts.  
3. **Attempt-scoped evidence + attempt-scoped remote workdirs**: each attempt has its own local evidence directory and HPC staging directory to prevent artifact overwrite.  
4. **Attempt-aware evidence export**: evidence bundles contain attempt history and link to attempt evidence directories, with legacy fallback.  
5. **Attempt-aware CLI**: `revive`, `rerun`, `attempts`, `cancel-attempt` (flat CLI style consistent with existing commands).  
6. **Canonical validation workspace**: [`workspaces/hpc_attempts_validation/`](../../workspaces/hpc_attempts_validation:1), demonstrating deterministic fail → rerun → succeed with preserved attempt evidence, both locally and on CURC Slurm `atesting`.

A live HPC run validated the end-to-end behavior with **real Slurm job IDs** persisted to attempts.

---

## 2. Core Design Intent

### 2.1 Problem Addressed
Prior to v0.2.5, MatterStack’s persisted execution state effectively assumed **one external run per task**. This made reruns risky because:
- evidence could be overwritten (or commingled)
- it was difficult to “re-run just one stage” after a walltime/resource misconfiguration
- provenance across iterative debugging was not structurally represented

### 2.2 v0.2.5 Design Outcome
- A logical task (`task_id`) remains stable in the workflow DAG.
- Each execution is an **attempt** with unique `attempt_id` and attempt-scoped evidence and remote working directory.
- Reruns create new attempts and preserve prior attempt evidence.

---

## 3. Implementation Detail (What Changed)

### 3.1 Storage: Schema v2 + Migration

**Files:**
- [`matterstack/storage/schema.py`](../../matterstack/storage/schema.py:1)
- [`matterstack/storage/state_store.py`](../../matterstack/storage/state_store.py:1)
- [`tests/unit/core/test_schema_version.py`](../../tests/unit/core/test_schema_version.py:1)

**Key changes:**
- Added schema v2 attempt table/model (`task_attempts`) and relationships.
- Extended tasks with `current_attempt_id` (nullable) to indicate the active/most-recent attempt.
- Implemented additive, non-destructive **v1→v2 migration** in [`SQLiteStateStore._check_schema()`](../../matterstack/storage/state_store.py:1).
  - Backfills one attempt per legacy external run.
  - Leaves legacy tables intact for backward compatibility.
  - Uses deterministic attempt IDs (uuid5) to make migration idempotent.

**Outcome:** Existing run DBs can be opened and upgraded without data loss.

---

### 3.2 Orchestration: Attempt-Aware Run Lifecycle

**Files:**
- [`matterstack/orchestration/run_lifecycle.py`](../../matterstack/orchestration/run_lifecycle.py:181)
- [`matterstack/storage/state_store.py`](../../matterstack/storage/state_store.py:1)
- Updated tests:
  - [`tests/integration/test_run_lifecycle_idempotent.py`](../../tests/integration/test_run_lifecycle_idempotent.py:1)
  - [`tests/integration/test_concurrency_caps.py`](../../tests/integration/test_concurrency_caps.py:1)

**Key changes:**
- **Attempt-first submit path**: orchestration creates attempt → operator prepare/submit → persists attempt metadata.
- **Attempt-aware polling**: active attempts are polled; task status is “healed/synced” based on attempt status.
- **Concurrency caps**: now count active attempts. Legacy external runs are counted only for attempt-less tasks (defensive fallback).
- **Results collection**: now prefers current attempt operator data; fallback to legacy external run only if attempts are absent.

**Outcome:** Run lifecycle supports multiple attempts per task without overwriting execution history.

---

### 3.3 Operators: Attempt-Scoped Evidence Dir + Attempt-Scoped HPC Workdir

**Files:**
- [`matterstack/runtime/fs_safety.py`](../../matterstack/runtime/fs_safety.py:1)
- [`matterstack/runtime/operators/hpc.py`](../../matterstack/runtime/operators/hpc.py:1)
- Interface change:
  - [`matterstack/core/backend.py`](../../matterstack/core/backend.py:24)
  - [`matterstack/runtime/backends/local.py`](../../matterstack/runtime/backends/local.py:85)
- Tests:
  - [`tests/unit/runtime/test_operator_direct_hpc.py`](../../tests/unit/runtime/test_operator_direct_hpc.py:1)

**Key changes:**
- Added safe attempt evidence dir helper: [`attempt_evidence_dir()`](../../matterstack/runtime/fs_safety.py:1).
- `ComputeBackend.submit()` extended with `local_debug_dir` (non-breaking default).
- `ComputeOperator.prepare_run()` now prefers attempt evidence directory when attempt context exists.
- `ComputeOperator` uses attempt-scoped remote workdir:
  - `<remote_root>/<workspace>/<run_id>/<task_id>/<attempt_id>/`
- Legacy fallback preserved if no attempt context can be discovered.

**Outcome:** Each attempt has its own evidence location (`manifest.json`, `submit.sh`, stdout/stderr, outputs) and unique HPC directory.

---

### 3.4 HPC Backend: Attempt-Scoped Downloads + Interface Alignment

**Files:**
- [`matterstack/runtime/backends/hpc/backend.py`](../../matterstack/runtime/backends/hpc/backend.py:240)
- [`tests/unit/runtime/hpc_mocks.py`](../../tests/unit/runtime/hpc_mocks.py:38)
- [`tests/unit/runtime/test_hpc_backend.py`](../../tests/unit/runtime/test_hpc_backend.py:1)

**Key changes:**
- Aligned `SlurmBackend.download()` keyword signature with [`ComputeBackend.download()`](../../matterstack/core/backend.py:66) to prevent runtime `TypeError`.
- Tests validate:
  - `workdir_override` is used for sbatch and file staging
  - `submit.sh` is persisted to `local_debug_dir`
  - include/exclude filtering works under `workdir_override`

**Outcome:** HPC behavior is compatible with attempt-scoped workdirs and attempt-scoped evidence.

---

### 3.5 Evidence Export: Attempt-Aware Evidence Bundle

**Files:**
- [`matterstack/storage/export.py`](../../matterstack/storage/export.py:1)
- Tests:
  - [`tests/unit/core/test_evidence_export.py`](../../tests/unit/core/test_evidence_export.py:1)
  - [`tests/unit/core/test_evidence_rebuild.py`](../../tests/unit/core/test_evidence_rebuild.py:1)

**Key changes:**
- Evidence export now includes for each task:
  - `attempts`: attempt history
  - `current_attempt`: current attempt snapshot (or last by index if pointer missing)
  - summary status/operator/external_id derived from current attempt
- Legacy fallback: if attempts are absent, export includes `legacy_external_run` (compat shim).
- Compatibility shim: `bundle.artifacts[task_id]` points to current attempt evidence dir if available.

**Outcome:** Evidence bundles remain consumable while now representing attempt history.

---

### 3.6 CLI: Attempt-Aware Commands (Flat Style)

**Files:**
- [`matterstack/cli/main.py`](../../matterstack/cli/main.py:1)
- [`matterstack/cli/reset.py`](../../matterstack/cli/reset.py:1)
- E2E test:
  - [`tests/e2e/test_cli_interaction.py`](../../tests/e2e/test_cli_interaction.py:1)

**Commands added:**
- `revive <run_id>`: transitions a terminal run back to `PENDING`
- `rerun <run_id> <task_id> [--recursive]`: resets target tasks to `PENDING`; next scheduler tick creates new attempts
- `attempts <run_id> <task_id>`: prints a stable TSV attempt list
- `cancel-attempt <run_id> <attempt_id>`: marks attempt cancelled in DB (backend cancellation currently “best effort” / logged)

**Outcome:** Operators can now revive and rerun without manual DB edits.

---

### 3.7 CLI/HPC Wiring: Operator Registry + HPC YAML Adapter

**Files:**
- [`matterstack/cli/operator_registry.py`](../../matterstack/cli/operator_registry.py:1)
- CLI flag plumbing:
  - [`matterstack/cli/main.py`](../../matterstack/cli/main.py:1)
- Loop plumbing:
  - [`run_until_completion()`](../../matterstack/orchestration/run_lifecycle.py:743)
- Tests:
  - [`tests/unit/cli/test_cli_operator_registry.py`](../../tests/unit/cli/test_cli_operator_registry.py:1)

**Key change:**
- CLI now supports `--hpc-config` as a compatibility adapter for CURC YAML (e.g. [`workspaces/mxene_shear_demo_V2/HPC_atesting_config.yaml`](../../workspaces/mxene_shear_demo_V2/HPC_atesting_config.yaml:1)), and threads the operator registry into orchestration.

**Outcome:** The CLI can submit real Slurm jobs using a configured HPC operator registry.

---

## 4. Canonical Validation Workspace (Local + HPC)

**Workspace:**
- [`workspaces/hpc_attempts_validation/`](../../workspaces/hpc_attempts_validation:1)
- Campaign: [`workspaces/hpc_attempts_validation/main.py`](../../workspaces/hpc_attempts_validation/main.py:1)
- Local harness: [`workspaces/hpc_attempts_validation/validation/validate_attempts.py`](../../workspaces/hpc_attempts_validation/validation/validate_attempts.py:1)
- Runbook: [`workspaces/hpc_attempts_validation/README.md`](../../workspaces/hpc_attempts_validation/README.md:1)

**Pattern:**
- DAG: `task_a -> task_b -> task_blocker`
- `task_b` intentionally fails attempt #1 and succeeds on attempt #2 after `rerun`.
- Attempt evidence is preserved under:
  - `runs/<run_id>/tasks/task_b/attempts/<attempt_id>/`

---

## 5. Live HPC Validation (CURC Alpine `atesting`)

**Config used:** [`workspaces/mxene_shear_demo_V2/HPC_atesting_config.yaml`](../../workspaces/mxene_shear_demo_V2/HPC_atesting_config.yaml:1)  
**Runbook:** [`workspaces/hpc_attempts_validation/README.md`](../../workspaces/hpc_attempts_validation/README.md:1)

**Live `run_id`:** `20251214_025031_3923daad`

**Attempt listing for `task_b`:**
```tsv
attempt_id	attempt_index	status	operator_type	external_id	artifact_path	config_hash
0bbae8b0-72bb-4e71-b1f3-5bb1ad1de36e	1	FAILED	HPC	21431324	tasks/task_b/attempts/0bbae8b0-72bb-4e71-b1f3-5bb1ad1de36e	
c3c3dd26-b9dc-46ce-a495-1979c53caa00	2	COMPLETED	HPC	21431334	tasks/task_b/attempts/c3c3dd26-b9dc-46ce-a495-1979c53caa00	
```

**What this proves:**
- Multiple attempts exist for a single logical task.
- Attempt evidence paths are distinct and preserved.
- Real Slurm job IDs are captured in `external_id`.

---

## 6. Testing Status (Release Gate)

### 6.1 Targeted Suites (Green)
Multiple targeted suites were executed and passing during implementation (unit/integration/e2e related to attempts). Examples include:
- Schema migration unit tests: [`tests/unit/core/test_schema_version.py`](../../tests/unit/core/test_schema_version.py:1)
- Orchestration integration tests: [`tests/integration/test_run_lifecycle_idempotent.py`](../../tests/integration/test_run_lifecycle_idempotent.py:1), [`tests/integration/test_concurrency_caps.py`](../../tests/integration/test_concurrency_caps.py:1)
- Evidence export tests: [`tests/unit/core/test_evidence_export.py`](../../tests/unit/core/test_evidence_export.py:1), [`tests/unit/core/test_evidence_rebuild.py`](../../tests/unit/core/test_evidence_rebuild.py:1)
- CLI e2e tests: [`tests/e2e/test_cli_interaction.py`](../../tests/e2e/test_cli_interaction.py:1)
- HPC backend tests: [`tests/unit/runtime/test_hpc_backend.py`](../../tests/unit/runtime/test_hpc_backend.py:1)

### 6.2 Full Suite (Green, With Mitigation Flag)
A full-suite run is now passing in this environment using the agreed pytest startup mitigation flag:

- Command: `MATTERSTACK_PYTEST_STUB_READLINE=1 python -m pytest`
- Result: `155 passed, 2 skipped, 227 warnings`

**Notes:**
- The `MATTERSTACK_PYTEST_STUB_READLINE=1` flag is an **opt-in** test-only mitigation for a pytest-startup segfault observed in this environment (see Section 7.1). It should not be enabled for normal CLI/runtime usage.

---

## 7. Known Issues / Technical Debt Introduced or Exposed

### 7.1 Pytest Startup Segfault Mitigation (Final Decision)
In this environment, importing CPython’s native `readline` extension can segfault during pytest startup (before `conftest.py` is imported). A repo-root shadow module (e.g. [`readline.py`](../../readline.py:1)) was used temporarily but is **too risky** because it can shadow the standard library extension whenever the repo root is on `sys.path` (impacting normal CLI / interactive behavior).

**Final decision:**
- The repo-root [`readline.py`](../../readline.py:1) shim is removed (no global shadowing risk).
- Test stability is maintained via an **explicit opt-in** startup hook in [`sitecustomize.py`](../../sitecustomize.py:1), which injects a minimal stub `readline` module **only when** `MATTERSTACK_PYTEST_STUB_READLINE=1` is set.

Recommended verification command:
`MATTERSTACK_PYTEST_STUB_READLINE=1 python -m pytest -q tests/e2e/test_cli_interaction.py`

Caveat: the stub is intentionally minimal and does not provide interactive readline functionality; do not enable it for normal runtime usage.

### 7.2 Config Hash / Snapshot Gaps
The attempts TSV includes a `config_hash` column but it is currently empty in the HPC run output. v0.2.5 plan expects attempt config snapshots and hashes; the plumbing is partially present, but config hashing is not yet consistently populated end-to-end.

### 7.3 Integration Test Coverage Still In Progress
The rerun/resume integration gating item is marked in-progress in tracking. While multiple targeted tests exist, full suite failures must be resolved to validate broader stability.

---

## 8. Recommendations (Next Steps)

1. Finalize test-only segfault mitigation:
   - Keep the approach **opt-in** via [`sitecustomize.py`](../../sitecustomize.py:1) and `MATTERSTACK_PYTEST_STUB_READLINE=1` for pytest runs in affected environments.
2. Populate attempt config hashing:
   - Ensure `config_hash` is computed and stored per attempt; include in CLI TSV and evidence bundle.
3. (Optional) Strengthen integration coverage:
   - The rerun/resume integration gating item is still tracked as in-progress; add/expand integration tests to validate no-evidence-overwrite under realistic rerun patterns.
4. Add a v0.2.5 changelog/version bump if project release process expects it:
   - [`CHANGELOG.md`](../../CHANGELOG.md:1), [`pyproject.toml`](../../pyproject.toml:1), and [`matterstack/__init__.py`](../../matterstack/__init__.py:1)

---

## 9. Appendix: Primary Artifacts / Entry Points

**Plan:**
- [`docs/DevGuides/DevGuide_v0.2.5.md`](DevGuide_v0.2.5.md:1)

**Core implementation:**
- Schema + state store: [`matterstack/storage/schema.py`](../../matterstack/storage/schema.py:1), [`matterstack/storage/state_store.py`](../../matterstack/storage/state_store.py:1)
- Orchestrator: [`matterstack/orchestration/run_lifecycle.py`](../../matterstack/orchestration/run_lifecycle.py:181)
- Operators/backends: [`matterstack/runtime/operators/hpc.py`](../../matterstack/runtime/operators/hpc.py:1), [`matterstack/runtime/backends/hpc/backend.py`](../../matterstack/runtime/backends/hpc/backend.py:1)
- Evidence: [`matterstack/storage/export.py`](../../matterstack/storage/export.py:1)
- CLI: [`matterstack/cli/main.py`](../../matterstack/cli/main.py:1), [`matterstack/cli/operator_registry.py`](../../matterstack/cli/operator_registry.py:1)

**Canonical validation workspace:**
- [`workspaces/hpc_attempts_validation/`](../../workspaces/hpc_attempts_validation:1)