from matterstack.core.domain import Material, Layer, StackTemplate
from matterstack.core.design_space import DesignSpace
from matterstack.core.environment import Environment
from matterstack.core.objective import Objective, Constraints
from matterstack.core.campaign_spec import CampaignConfig, Tier
from matterstack.runtime.context import RuntimeContext, HPCClient, LabClient
from matterstack.campaign.engine import CampaignState
from matterstack.core.operators import register_simulator

@register_simulator(name="sim_dummy", tier="cheap")
def sim_dummy(candidate, env, ctx):
    return {"time_to_failure": len(candidate.params)}

def test_campaign_grid_single_tier():
    aa7075 = Material(id="AA7075-T6", kind="alloy")
    tmpl = StackTemplate(
        name="AA7075_Coating",
        substrate=aa7075,
        layers=[Layer(name="primer"), Layer(name="topcoat")],
    )
    ds = DesignSpace(tmpl)
    ds.vary_discrete("primer.formulation", lib="primer_v0")
    ds.vary_discrete("topcoat.type", lib="topcoat_v0")

    env = Environment.marine_spray("3.5 wt%", "35C", 8, 16, 5)
    objective = Objective(primary="time_to_failure", constraints=Constraints())

    tiers = [Tier(name="cheap", op="sim_dummy", budget=10)]
    cfg = CampaignConfig(
        name="test_campaign",
        design_space=ds,
        environment=env,
        objective=objective,
        tiers=tiers,
        strategy="grid",
    )

    ctx = RuntimeContext(
        hpc=HPCClient(),
        lab=LabClient(),
        models={"lib_registry": {"primer_v0": ["pA"], "topcoat_v0": ["tA", "tB"]}},
    )

    cs = CampaignState(config=cfg, ctx=ctx)
    cs.run_grid_single_tier()
    assert cs.done()
    assert len(cs.candidates) >= 2
    best = cs.best_candidates(top_k=1)[0]
    assert "time_to_failure" in best.metrics