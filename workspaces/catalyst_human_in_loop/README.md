# Catalyst Discovery with Human-in-the-Loop

**Integrating Expert Intuition into Automated Computational Workflows**

> **Disclaimer:** This project uses entirely simulated data. The "adsorption energies" and "candidates" are generated randomly for demonstration purposes. No actual DFT calculations or chemical synthesis are performed.

## 1. Abstract
This workspace demonstrates a hybrid "Human-AI" workflow for catalyst discovery. While automated algorithms excel at screening vast databases, human experts are often needed to validate safety constraints, assess synthesizeability, or make subjective judgment calls. This project implements a **Human Gate** mechanism that pauses the computational pipeline to solicit expert approval before launching expensive downstream simulations.

## 2. Scientific Background
In heterogeneous catalysis research (e.g., CO2 reduction or Nitrogen fixation), the search for new active sites is often guided by Density Functional Theory (DFT).
- **The Problem**: DFT calculations are computationally costly (thousands of CPU hours). It is wasteful to run them on candidates that a chemist knows are practically impossible to synthesize or unstable under reaction conditions.
- **The Solution**: Insert a "checkpoint" where an expert reviews the proposed candidates generated by the AI, filtering out the non-viable ones before the heavy compute begins.

## 3. Computational Challenge
Automating a workflow that includes a human pause is non-trivial.
- **State Persistence**: The workflow must "sleep" efficiently without blocking a thread or consuming resources while waiting for the human (which could take minutes or days).
- **Interface**: There must be a clear mechanism for the human to signal "Approve" or "Reject".
- **Dynamic Branching**: The subsequent workflow structure depends on how many and which candidates were approved.

## 4. MatterStack Solution
This project utilizes the **`HumanOperator`** capability.
- **Blocking Execution**: The workflow pauses at the `human_approval` task, which is dispatched to the `HumanOperator`.
- **Task Directory**: The system creates a dedicated directory `runs/<run_id>/operators/human/<uuid>/`.
- **Mechanism**: The operator waits for a `response.json` file to appear in this directory (simulating a UI or manual entry).
- **Seamless Resume**: Once the response is detected, the workflow automatically resumes, triggering the dependent downstream tasks.

## 5. Workflow Architecture
The pipeline defined in `main.py` consists of four stages:

1.  **Candidate Proposal (`propose_candidates`)**:
    - Parses a high-level intent (e.g., "Find Cu-based catalysts") and generates a list of potential structures.
    - Output: `candidates.csv` (saved in the task's output directory).
2.  **Human Gate (`human_approval`)**:
    - A `Task` configured with `MATTERSTACK_OPERATOR="Human"`.
    - **Instruction**: "Please review candidates.csv and approve."
    - **Simulation**: A background thread monitors the operator directory and automatically writes `response.json` after a delay.
3.  **Fan-Out Simulations (`calc_ads_N`)**:
    - *Only* after the gate opens, the workflow launches parallel adsorption energy calculations (`calc_adsorption.py`) for the approved candidates.
4.  **Ranking (`rank_results`)**:
    - Aggregates the computed adsorption energies and ranks the catalysts.

## 6. Execution & Results

### Running the Workflow
```bash
python3 main.py
```
*Note: For demonstration purposes, a background thread simulates the human expert by automatically creating the approval response after a delay.*

### Expected Output
```text
Initializing Run...
[Human Simulator] Watching workspaces/catalyst_human_in_loop/runs/.../operators/human...
...
[Human Simulator] Found task: ...
[Human Simulator] Approved task in .../response.json
...
Task human_approval completed (found response.json).
External Run human_approval transitioned to ExternalRunStatus.COMPLETED
Task 'calc_ads_0' status: RUNNING
...
Workflow Completed.
```
This confirms that the expensive calculation tasks (`calc_ads_*`) were effectively blocked until the "Human" provided the necessary authorization.